(function(v,S){typeof exports=="object"&&typeof module<"u"?S(exports):typeof define=="function"&&define.amd?define(["exports"],S):(v=typeof globalThis<"u"?globalThis:v||self,S(v.ArkeUploadClient={}))})(this,function(v){"use strict";var Ct=Object.defineProperty;var $t=(v,S,$)=>S in v?Ct(v,S,{enumerable:!0,configurable:!0,writable:!0,value:$}):v[S]=$;var h=(v,S,$)=>$t(v,typeof S!="symbol"?S+"":S,$);var me;class S extends Error{constructor(e,t,n){super(e),this.statusCode=t,this.details=n,this.name="WorkerAPIError",Error.captureStackTrace(this,this.constructor)}}class $ extends Error{constructor(e,t,n,i){super(e),this.fileName=t,this.statusCode=n,this.cause=i,this.name="UploadError",Error.captureStackTrace(this,this.constructor)}}class E extends Error{constructor(e,t){super(e),this.field=t,this.name="ValidationError",Error.captureStackTrace(this,this.constructor)}}class F extends Error{constructor(e,t){super(e),this.cause=t,this.name="NetworkError",Error.captureStackTrace(this,this.constructor)}}class z extends Error{constructor(e,t){super(e),this.path=t,this.name="ScanError",Error.captureStackTrace(this,this.constructor)}}function ge(r){return r instanceof F?!0:r instanceof S?r.statusCode?r.statusCode>=500:!1:r instanceof $?r.statusCode?r.statusCode>=500||r.statusCode===429:!1:r.code==="ECONNRESET"||r.code==="ETIMEDOUT"||r.code==="ENOTFOUND"||r.code==="ECONNREFUSED"}const be={maxRetries:3,initialDelay:1e3,maxDelay:3e4,shouldRetry:ge,jitter:!0};async function j(r,e={}){const t={...be,...e};let n;for(let i=0;i<=t.maxRetries;i++)try{return await r()}catch(o){if(n=o,i>=t.maxRetries||t.shouldRetry&&!t.shouldRetry(o))throw o;let s;if(o.statusCode===429&&o.retryAfter?s=Math.min(o.retryAfter*1e3,t.maxDelay):s=Math.min(t.initialDelay*Math.pow(2,i),t.maxDelay),t.jitter){const a=s*.25;s=s+(Math.random()*a*2-a)}await xe(Math.floor(s))}throw n}function xe(r){return new Promise(e=>setTimeout(e,r))}class ve{constructor(e){h(this,"baseUrl");h(this,"timeout");h(this,"maxRetries");h(this,"retryInitialDelay");h(this,"retryMaxDelay");h(this,"retryJitter");h(this,"debug");this.baseUrl=e.baseUrl,this.timeout=e.timeout??3e4,this.maxRetries=e.maxRetries??3,this.retryInitialDelay=e.retryInitialDelay??1e3,this.retryMaxDelay=e.retryMaxDelay??3e4,this.retryJitter=e.retryJitter??!0,this.debug=e.debug??!1}async request(e,t,n){const i=`${this.baseUrl}${t}`;this.debug&&console.log(`HTTP Request: ${e} ${i}`,n);try{const o=new AbortController,s=setTimeout(()=>o.abort(),this.timeout),a=await fetch(i,{method:e,headers:{"Content-Type":"application/json"},body:n?JSON.stringify(n):void 0,signal:o.signal});clearTimeout(s);const c=await a.json();if(this.debug&&console.log(`HTTP Response: ${a.status}`,c),!a.ok){const u=c;throw new S(u.error||"Request failed",a.status,u.details)}return c}catch(o){throw o instanceof S?o:o.name==="AbortError"?new F(`Request timeout after ${this.timeout}ms`):new F(`Network request failed: ${o.message}`)}}async initBatch(e){return j(()=>this.request("POST","/api/batches/init",e),{maxRetries:this.maxRetries,initialDelay:this.retryInitialDelay,maxDelay:this.retryMaxDelay,jitter:this.retryJitter})}async startFileUpload(e,t){return j(()=>this.request("POST",`/api/batches/${e}/files/start`,t),{maxRetries:this.maxRetries,initialDelay:this.retryInitialDelay,maxDelay:this.retryMaxDelay,jitter:this.retryJitter})}async completeFileUpload(e,t){return j(()=>this.request("POST",`/api/batches/${e}/files/complete`,t),{maxRetries:this.maxRetries,initialDelay:this.retryInitialDelay,maxDelay:this.retryMaxDelay,jitter:this.retryJitter})}async finalizeBatch(e){return j(()=>this.request("POST",`/api/batches/${e}/finalize`,{}),{maxRetries:this.maxRetries,initialDelay:this.retryInitialDelay,maxDelay:this.retryMaxDelay,jitter:this.retryJitter})}}function Ee(){return typeof process<"u"&&process.versions!=null&&process.versions.node!=null?"node":typeof window<"u"&&typeof document<"u"?"browser":"unknown"}function Z(r){return r.replace(/\\/g,"/")}function De(r){const e=r.lastIndexOf(".");return e===-1?"":r.slice(e+1).toLowerCase()}function Y(r){const e=De(r);return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",tif:"image/tiff",tiff:"image/tiff",bmp:"image/bmp",svg:"image/svg+xml",pdf:"application/pdf",txt:"text/plain",json:"application/json",xml:"application/xml",html:"text/html",htm:"text/html",css:"text/css",js:"application/javascript",zip:"application/zip",tar:"application/x-tar",gz:"application/gzip",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg",mp4:"video/mp4",webm:"video/webm",mov:"video/quicktime"}[e]||"application/octet-stream"}async function Se(r,e,t,n={}){const{maxRetries:i=3,retryInitialDelay:o,retryMaxDelay:s,retryJitter:a}=n;await j(async()=>{let c;try{c=await fetch(e,{method:"PUT",body:r,headers:{...t?{"Content-Type":t}:{}}})}catch(u){throw new $(`Upload failed: ${u.message}`,void 0,void 0,u)}if(!c.ok){const u=c.headers.get("retry-after"),l=new $(`Upload failed with status ${c.status}: ${c.statusText}`,void 0,c.status);throw u&&c.status===429&&(l.retryAfter=parseInt(u,10)),l}},{maxRetries:i,initialDelay:o,maxDelay:s,jitter:a})}async function Ce(r,e,t=3,n={}){const i=r.byteLength,o=Math.ceil(i/e.length),s=[],a=[],{maxRetries:c=3,retryInitialDelay:u,retryMaxDelay:l,retryJitter:d}=n;for(let p=0;p<e.length;p++){const D=p+1,f=p*o,w=Math.min(f+o,i),m=r.slice(f,w),b=e[p];a.push(async()=>{const y=await $e(m,b,D,c,{initialDelay:u,maxDelay:l,jitter:d});s.push({part_number:D,etag:y})})}return await Pe(a,t),s.sort((p,D)=>p.part_number-D.part_number),s}async function $e(r,e,t,n=3,i={}){return j(async()=>{let o;try{o=await fetch(e,{method:"PUT",body:r})}catch(a){throw new $(`Part ${t} upload failed: ${a.message}`,void 0,void 0,a)}if(!o.ok){const a=o.headers.get("retry-after"),c=new $(`Part ${t} upload failed with status ${o.status}: ${o.statusText}`,void 0,o.status);throw a&&o.status===429&&(c.retryAfter=parseInt(a,10)),c}const s=o.headers.get("etag");if(!s)throw new $(`Part ${t} upload succeeded but no ETag returned`,void 0,o.status);return s.replace(/"/g,"")},{maxRetries:n,initialDelay:i.initialDelay,maxDelay:i.maxDelay,jitter:i.jitter})}async function Pe(r,e){const t=[...r],n=[],i=async()=>{for(;t.length>0;)await t.shift()()};for(let o=0;o<Math.min(e,r.length);o++)n.push(i());await Promise.all(n)}const ee=5*1024*1024*1024,te=100*1024*1024*1024,Te=/[<>:"|?*\x00-\x1f]/,Ue=["image/jpeg","image/png","image/webp"];function re(r){if(r<=0)throw new E("File size must be greater than 0");if(r>ee)throw new E(`File size (${N(r)}) exceeds maximum allowed size (${N(ee)})`)}function Ae(r){if(r>te)throw new E(`Total batch size (${N(r)}) exceeds maximum allowed size (${N(te)})`)}function R(r){if(!r.startsWith("/"))throw new E("Logical path must start with /","path");if(Te.test(r))throw new E("Logical path contains invalid characters","path");const e=r.split("/").filter(t=>t.length>0);if(e.length===0&&r!=="/")throw new E("Logical path cannot be empty","path");for(const t of e)if(t==="."||t==="..")throw new E("Logical path cannot contain . or .. segments","path")}function ke(r,e,t){let n;try{n=JSON.parse(r)}catch(i){throw new E(`Invalid JSON in ${e}: ${i.message}`,"ref")}if(typeof n!="object"||Array.isArray(n)||n===null)throw new E(`${e} must contain a JSON object`,"ref");if(!n.url||typeof n.url!="string")throw new E(`${e} must contain a 'url' field with a string value`,"ref");try{const i=new URL(n.url);if(i.protocol!=="http:"&&i.protocol!=="https:")throw new Error("URL must use HTTP or HTTPS protocol")}catch(i){throw new E(`Invalid URL in ${e}: ${i.message}`,"ref")}if(n.type||t&&t.warn(`${e}: Missing 'type' field (optional but recommended)`),n.type&&Ue.includes(n.type)){const o={"image/jpeg":".jpg","image/png":".png","image/webp":".webp"}[n.type];o&&!e.includes(`${o}.ref.json`)&&t&&t.warn(`${e}: Type is '${n.type}' but filename doesn't include '${o}.ref.json' pattern. This file may not be processed by OCR. Consider renaming to include the extension (e.g., 'photo${o}.ref.json').`)}}function N(r){if(r===0)return"0 B";const e=1024,t=["B","KB","MB","GB","TB"],n=Math.floor(Math.log(r)/Math.log(e));return`${(r/Math.pow(e,n)).toFixed(2)} ${t[n]}`}function ze(r){if(!r)return;const e=2e3,t=8e3,n=["general","reorganization","pinax","description","cheimarros"];let i=0;for(const o of n){const s=r[o];if(s){if(s.length>e)throw new E(`Custom prompt '${o}' exceeds maximum length of ${e} characters (current: ${s.length})`,"customPrompts");i+=s.length}}if(i>t)throw new E(`Total custom prompts length (${i}) exceeds maximum of ${t} characters`,"customPrompts")}function Me(r){if(r&&"customPrompts"in r)throw new E("customPrompts must be a top-level field in UploaderConfig, not inside the processing config. Use: new ArkeUploader({ customPrompts: {...}, processing: {...} }) NOT: new ArkeUploader({ processing: { customPrompts: {...} } })","processing")}class Ie{constructor(e){h(this,"config");h(this,"workerClient");h(this,"scanner",null);h(this,"platform");Me(e.processing),this.config={rootPath:"/",parallelUploads:5,parallelParts:3,...e},this.workerClient=new ve({baseUrl:e.workerUrl,timeout:e.timeout,maxRetries:e.maxRetries,retryInitialDelay:e.retryInitialDelay,retryMaxDelay:e.retryMaxDelay,retryJitter:e.retryJitter,debug:!1}),this.platform=Ee()}async getScanner(){if(this.scanner)return this.scanner;if(this.platform==="node"){const{NodeScanner:e}=await Promise.resolve().then(()=>Et);this.scanner=new e}else if(this.platform==="browser"){const{BrowserScanner:e}=await Promise.resolve().then(()=>St);this.scanner=new e}else throw new E("Unsupported platform");return this.scanner}async uploadBatch(e,t={}){const n=Date.now(),{onProgress:i,dryRun:o=!1}=t;this.reportProgress(i,{phase:"scanning",filesTotal:0,filesUploaded:0,bytesTotal:0,bytesUploaded:0,percentComplete:0});const a=await(await this.getScanner()).scanFiles(e,{rootPath:this.config.rootPath||"/",followSymlinks:!0,defaultProcessingConfig:this.config.processing});if(a.length===0)throw new E("No files found to upload");const c=a.reduce((p,D)=>p+D.size,0);if(Ae(c),this.config.customPrompts){ze(this.config.customPrompts);const p=Object.keys(this.config.customPrompts).filter(D=>this.config.customPrompts[D]);console.log(`[Arke Upload SDK] Custom prompts configured: ${p.join(", ")}`)}if(o)return{batchId:"dry-run",filesUploaded:a.length,bytesUploaded:c,durationMs:Date.now()-n};const{batch_id:u}=await this.workerClient.initBatch({uploader:this.config.uploader,root_path:this.config.rootPath||"/",parent_pi:this.config.parentPi||"",metadata:this.config.metadata,file_count:a.length,total_size:c,custom_prompts:this.config.customPrompts});this.config.customPrompts&&console.log(`[Arke Upload SDK] Custom prompts sent to worker for batch ${u}`),this.reportProgress(i,{phase:"uploading",filesTotal:a.length,filesUploaded:0,bytesTotal:c,bytesUploaded:0,percentComplete:0});let l=0,d=0;return await this.uploadFilesWithConcurrency(u,a,e,this.config.parallelUploads||5,(p,D)=>{l++,d+=D,this.reportProgress(i,{phase:"uploading",filesTotal:a.length,filesUploaded:l,bytesTotal:c,bytesUploaded:d,currentFile:p.fileName,percentComplete:Math.round(d/c*100)})}),this.reportProgress(i,{phase:"finalizing",filesTotal:a.length,filesUploaded:l,bytesTotal:c,bytesUploaded:d,percentComplete:99}),await this.workerClient.finalizeBatch(u),this.reportProgress(i,{phase:"complete",filesTotal:a.length,filesUploaded:l,bytesTotal:c,bytesUploaded:d,percentComplete:100}),{batchId:u,filesUploaded:l,bytesUploaded:d,durationMs:Date.now()-n}}async uploadFilesWithConcurrency(e,t,n,i,o){const s=[...t],a=[],c=async()=>{for(;s.length>0;){const u=s.shift();await this.uploadSingleFile(e,u,n),o(u,u.size)}};for(let u=0;u<Math.min(i,t.length);u++)a.push(c());await Promise.all(a)}async uploadSingleFile(e,t,n){const i=await this.workerClient.startFileUpload(e,{file_name:t.fileName,file_size:t.size,logical_path:t.logicalPath,content_type:t.contentType,cid:t.cid,processing_config:t.processingConfig}),o=await this.getFileData(t,n),s={maxRetries:this.config.maxRetries,retryInitialDelay:this.config.retryInitialDelay,retryMaxDelay:this.config.retryMaxDelay,retryJitter:this.config.retryJitter};if(i.upload_type==="simple")await Se(o,i.presigned_url,t.contentType,s);else{const a=i.presigned_urls.map(u=>u.url),c=await Ce(o,a,this.config.parallelParts||3,s);await this.workerClient.completeFileUpload(e,{r2_key:i.r2_key,upload_id:i.upload_id,parts:c});return}await this.workerClient.completeFileUpload(e,{r2_key:i.r2_key})}async getFileData(e,t){if(this.platform==="node"){const i=await(await Promise.resolve().then(()=>ne)).readFile(e.localPath);return i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength)}else if(this.platform==="browser"){const i=(Array.isArray(t)?t:[t]).find(o=>o instanceof File&&o.name===e.fileName);if(!i)throw new Error(`Could not find browser File object for ${e.fileName}`);return i.arrayBuffer()}throw new Error("Unsupported platform for file reading")}reportProgress(e,t){e&&e(t)}}const C={},ne=Object.freeze(Object.defineProperty({__proto__:null,default:C},Symbol.toStringTag,{value:"Module"}));function je(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function W(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function Oe(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var o=r.charAt(i),s=o.charCodeAt(0);if(t[s]!==255)throw new TypeError(o+" is ambiguous");t[s]=i}var a=r.length,c=r.charAt(0),u=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var w=0,m=0,b=0,y=f.length;b!==y&&f[b]===0;)b++,w++;for(var g=(y-b)*l+1>>>0,P=new Uint8Array(g);b!==y;){for(var U=f[b],I=0,T=g-1;(U!==0||I<m)&&T!==-1;T--,I++)U+=256*P[T]>>>0,P[T]=U%a>>>0,U=U/a>>>0;if(U!==0)throw new Error("Non-zero carry");m=I,b++}for(var k=g-m;k!==g&&P[k]===0;)k++;for(var V=c.repeat(w);k<g;++k)V+=r.charAt(P[k]);return V}function p(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var w=0;if(f[w]!==" "){for(var m=0,b=0;f[w]===c;)m++,w++;for(var y=(f.length-w)*u+1>>>0,g=new Uint8Array(y);f[w];){var P=t[f.charCodeAt(w)];if(P===255)return;for(var U=0,I=y-1;(P!==0||U<b)&&I!==-1;I--,U++)P+=a*g[I]>>>0,g[I]=P%256>>>0,P=P/256>>>0;if(P!==0)throw new Error("Non-zero carry");b=U,w++}if(f[w]!==" "){for(var T=y-b;T!==y&&g[T]===0;)T++;for(var k=new Uint8Array(m+(y-T)),V=m;T!==y;)k[V++]=g[T++];return k}}}function D(f){var w=p(f);if(w)return w;throw new Error(`Non-${e} character`)}return{encode:d,decodeUnsafe:p,decode:D}}var Fe=Oe,Re=Fe;class Ne{constructor(e,t,n){h(this,"name");h(this,"prefix");h(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class _e{constructor(e,t,n){h(this,"name");h(this,"prefix");h(this,"baseDecode");h(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return ie(this,e)}}class Le{constructor(e){h(this,"decoders");this.decoders=e}or(e){return ie(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function ie(r,e){return new Le({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}class Be{constructor(e,t,n,i){h(this,"name");h(this,"prefix");h(this,"baseEncode");h(this,"baseDecode");h(this,"encoder");h(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Ne(e,t,n),this.decoder=new _e(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function oe({name:r,prefix:e,encode:t,decode:n}){return new Be(r,e,t,n)}function _({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Re(t,r);return oe({prefix:e,name:r,encode:n,decode:o=>W(i(o))})}function qe(r,e,t,n){let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let s=0,a=0,c=0;for(let u=0;u<i;++u){const l=e[r[u]];if(l===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|l,s+=t,s>=8&&(s-=8,o[c++]=255&a>>s)}if(s>=t||255&a<<8-s)throw new SyntaxError("Unexpected end of data");return o}function Je(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let o="",s=0,a=0;for(let c=0;c<r.length;++c)for(a=a<<8|r[c],s+=8;s>t;)s-=t,o+=e[i&a>>s];if(s!==0&&(o+=e[i&a<<t-s]),n)for(;o.length*t&7;)o+="=";return o}function Ve(r){const e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function A({name:r,prefix:e,bitsPerChar:t,alphabet:n}){const i=Ve(n);return oe({prefix:e,name:r,encode(o){return Je(o,n,t)},decode(o){return qe(o,i,t,r)}})}const L=A({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});A({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),A({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),A({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),A({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),A({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),A({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),A({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),A({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const G=_({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});_({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const M=_({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});_({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var We=ae,se=128,Ge=-128,He=Math.pow(2,31);function ae(r,e,t){e=e||[],t=t||0;for(var n=t;r>=He;)e[t++]=r&255|se,r/=128;for(;r&Ge;)e[t++]=r&255|se,r>>>=7;return e[t]=r|0,ae.bytes=t-n+1,e}var Ke=H,Xe=128,ce=127;function H(r,n){var t=0,n=n||0,i=0,o=n,s,a=r.length;do{if(o>=a)throw H.bytes=0,new RangeError("Could not decode varint");s=r[o++],t+=i<28?(s&ce)<<i:(s&ce)*Math.pow(2,i),i+=7}while(s>=Xe);return H.bytes=o-n,t}var Qe=Math.pow(2,7),Ze=Math.pow(2,14),Ye=Math.pow(2,21),et=Math.pow(2,28),tt=Math.pow(2,35),rt=Math.pow(2,42),nt=Math.pow(2,49),it=Math.pow(2,56),ot=Math.pow(2,63),st=function(r){return r<Qe?1:r<Ze?2:r<Ye?3:r<et?4:r<tt?5:r<rt?6:r<nt?7:r<it?8:r<ot?9:10},at={encode:We,decode:Ke,encodingLength:st},B=at;function K(r,e=0){return[B.decode(r,e),B.decode.bytes]}function q(r,e,t=0){return B.encode(r,e,t),e}function J(r){return B.encodingLength(r)}function le(r,e){const t=e.byteLength,n=J(r),i=n+J(t),o=new Uint8Array(i+t);return q(r,o,0),q(t,o,n),o.set(e,i),new X(r,t,e,o)}function ct(r){const e=W(r),[t,n]=K(e),[i,o]=K(e.subarray(n)),s=e.subarray(n+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new X(t,i,s,e)}function lt(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&je(r.bytes,t.bytes)}}class X{constructor(e,t,n,i){h(this,"code");h(this,"size");h(this,"digest");h(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}}function he(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return ft(t,Q(r),e??M.encoder);default:return ut(t,Q(r),e??L.encoder)}}const fe=new WeakMap;function Q(r){const e=fe.get(r);if(e==null){const t=new Map;return fe.set(r,t),t}return e}class x{constructor(e,t,n,i){h(this,"code");h(this,"version");h(this,"multihash");h(this,"bytes");h(this,"/");h(this,me,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==O)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==dt)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return x.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=le(e,t);return x.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return x.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&lt(e.multihash,n.multihash)}toString(e){return he(this,e)}toJSON(){return{"/":he(this)}}link(){return this}[(me=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof x)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:o,bytes:s}=t;return new x(n,i,o,s??ue(n,i,o.bytes))}else if(t[pt]===!0){const{version:n,multihash:i,code:o}=t,s=ct(i);return x.create(n,o,s)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==O)throw new Error(`Version 0 CID must use dag-pb (code: ${O}) block encoding`);return new x(e,t,n,n.bytes)}case 1:{const i=ue(e,t,n.bytes);return new x(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return x.create(0,O,e)}static createV1(e,t){return x.create(1,e,t)}static decode(e){const[t,n]=x.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=x.inspectBytes(e),n=t.size-t.multihashSize,i=W(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const o=i.subarray(t.multihashSize-t.digestSize),s=new X(t.multihashCode,t.digestSize,o,i);return[t.version===0?x.createV0(s):x.createV1(t.codec,s),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[d,p]=K(e.subarray(t));return t+=p,d};let i=n(),o=O;if(i===18?(i=0,t=0):o=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const s=t,a=n(),c=n(),u=t+c,l=u-s;return{version:i,codec:o,multihashCode:a,digestSize:c,multihashSize:l,size:u}}static parse(e,t){const[n,i]=ht(e,t),o=x.decode(i);if(o.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Q(o).set(n,e),o}}function ht(r,e){switch(r[0]){case"Q":{const t=e??M;return[M.prefix,t.decode(`${M.prefix}${r}`)]}case M.prefix:{const t=e??M;return[M.prefix,t.decode(r)]}case L.prefix:{const t=e??L;return[L.prefix,t.decode(r)]}case G.prefix:{const t=e??G;return[G.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function ft(r,e,t){const{prefix:n}=t;if(n!==M.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const o=t.encode(r).slice(1);return e.set(n,o),o}else return i}function ut(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const o=t.encode(r);return e.set(n,o),o}else return i}const O=112,dt=18;function ue(r,e,t){const n=J(r),i=n+J(e),o=new Uint8Array(i+t.byteLength);return q(r,o,0),q(e,o,n),o.set(t,i),o}const pt=Symbol.for("@ipld/js-cid/CID"),de=85,yt=20;function wt({name:r,code:e,encode:t,minDigestLength:n,maxDigestLength:i}){return new mt(r,e,t,n,i)}class mt{constructor(e,t,n,i,o){h(this,"name");h(this,"code");h(this,"encode");h(this,"minDigestLength");h(this,"maxDigestLength");this.name=e,this.code=t,this.encode=n,this.minDigestLength=i??yt,this.maxDigestLength=o}digest(e,t){if((t==null?void 0:t.truncate)!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){const n=this.encode(e);return n instanceof Uint8Array?pe(n,this.code,t==null?void 0:t.truncate):n.then(i=>pe(i,this.code,t==null?void 0:t.truncate))}else throw Error("Unknown type, must be binary type")}}function pe(r,e,t){if(t!=null&&t!==r.byteLength){if(t>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,t)}return le(e,r)}function gt(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const ye=wt({name:"sha2-256",code:18,encode:gt("SHA-256")});async function bt(r){const e=await Promise.resolve().then(()=>ne);try{const t=await e.readFile(r),n=await ye.digest(t);return x.create(1,de,n).toString()}catch(t){throw new Error(`CID computation failed: ${t.message}`)}}async function xt(r){const e=await ye.digest(r);return x.create(1,de,e).toString()}const we={ocr:!0,describe:!0,pinax:!0};class vt{async scanFiles(e,t){const n=Array.isArray(e)?e[0]:e;if(!n||typeof n!="string")throw new z("Node.js scanner requires a directory path","");const i=[];try{if(!(await C.stat(n)).isDirectory())throw new z(`Path is not a directory: ${n}`,n)}catch(l){throw l.code==="ENOENT"?new z(`Directory not found: ${n}`,n):new z(`Cannot access directory: ${l.message}`,n)}R(t.rootPath);const o=t.defaultProcessingConfig||we;async function s(l){const d=C.join(l,".arke-process.json");try{const p=await C.readFile(d,"utf-8");return JSON.parse(p)}catch(p){return p.code!=="ENOENT"&&console.warn(`Error reading processing config ${d}: ${p.message}`),null}}function a(l,d){return d?{ocr:d.ocr??l.ocr,describe:d.describe??l.describe,pinax:d.pinax??l.pinax}:l}async function c(l,d=""){const p=await s(l),D=a(o,p);let f;try{f=await C.readdir(l,{withFileTypes:!0})}catch(w){console.warn(`Cannot read directory: ${l}`,w.message);return}for(const w of f){const m=C.join(l,w.name),b=C.join(d,w.name);try{if(w.isSymbolicLink()){if(!t.followSymlinks)continue;const y=await C.stat(m);y.isDirectory()?await c(m,b):y.isFile()&&await u(m,b,y.size,D);continue}if(w.isDirectory()){await c(m,b);continue}if(w.isFile()){const y=await C.stat(m);await u(m,b,y.size,D)}}catch(y){if(y instanceof z&&y.message.includes(".ref.json"))throw y;console.warn(`Error processing ${m}: ${y.message}`);continue}}}async function u(l,d,p,D){const f=C.basename(l);if(f===".arke-process.json")return;if(f.endsWith(".ref.json"))try{const g=await C.readFile(l,"utf-8");ke(g,f,console)}catch(g){throw new z(`Invalid .ref.json file: ${f} - ${g.message}`,l)}try{re(p)}catch(g){console.warn(`Skipping file that exceeds size limit: ${f}`,g.message);return}const w=Z(d),m=C.posix.join(t.rootPath,w);try{R(m)}catch(g){console.warn(`Skipping file with invalid logical path: ${m}`,g.message);return}const b=Y(f);try{await C.access(l,C.constants.R_OK)}catch{console.warn(`Skipping unreadable file: ${l}`);return}let y;try{y=await bt(l)}catch(g){console.warn(`Warning: CID computation failed for ${l}, continuing without CID:`,g.message),y=void 0}i.push({localPath:l,logicalPath:m,fileName:f,size:p,contentType:b,cid:y,processingConfig:D})}return await c(n),i.sort((l,d)=>l.size-d.size),i}async readFile(e){const t=await C.readFile(e.localPath);return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}}const Et=Object.freeze(Object.defineProperty({__proto__:null,NodeScanner:vt},Symbol.toStringTag,{value:"Module"}));class Dt{async scanFiles(e,t){const n=Array.isArray(e)?e:[e];if(n.length===0)throw new z("No files provided","");R(t.rootPath);const i=t.defaultProcessingConfig||we,o=[];for(const s of n)try{const a=await this.processFile(s,t.rootPath,i);a&&o.push(a)}catch(a){console.warn(`Error processing ${s.name}: ${a.message}`);continue}return o.sort((s,a)=>s.size-a.size),o}async processFile(e,t,n){const i=e.name,o=e.size;if(i===".arke-process.json")return null;try{re(o)}catch(d){return console.warn(`Skipping file that exceeds size limit: ${i}`,d.message),null}let s="";if("webkitRelativePath"in e&&e.webkitRelativePath){const d=e.webkitRelativePath.split("/");d.length>1?s=d.slice(1).join("/"):s=i}else s=i;const a=Z(s),c=`${t}/${a}`.replace(/\/+/g,"/");try{R(c)}catch(d){return console.warn(`Skipping file with invalid logical path: ${c}`,d.message),null}const u=e.type||Y(i);let l;try{const d=await e.arrayBuffer();l=await xt(new Uint8Array(d))}catch(d){console.warn(`Warning: CID computation failed for ${i}, continuing without CID:`,d.message),l=void 0}return{localPath:`__browser_file__${i}`,logicalPath:c,fileName:i,size:o,contentType:u,cid:l,processingConfig:n}}async readFile(e){throw new Error("Browser scanner requires File objects to be provided directly during upload")}}const St=Object.freeze(Object.defineProperty({__proto__:null,BrowserScanner:Dt},Symbol.toStringTag,{value:"Module"}));v.ArkeUploader=Ie,v.NetworkError=F,v.ScanError=z,v.UploadError=$,v.ValidationError=E,v.WorkerAPIError=S,Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});
