(function(E,D){typeof exports=="object"&&typeof module<"u"?D(exports):typeof define=="function"&&define.amd?define(["exports"],D):(E=typeof globalThis<"u"?globalThis:E||self,D(E.ArkeUploadClient={}))})(this,function(E){"use strict";var $t=Object.defineProperty;var Ct=(E,D,C)=>D in E?$t(E,D,{enumerable:!0,configurable:!0,writable:!0,value:C}):E[D]=C;var u=(E,D,C)=>Ct(E,typeof D!="symbol"?D+"":D,C);var ge;class D extends Error{constructor(e,t,n){super(e),this.statusCode=t,this.details=n,this.name="WorkerAPIError",Error.captureStackTrace(this,this.constructor)}}class C extends Error{constructor(e,t,n,i){super(e),this.fileName=t,this.statusCode=n,this.cause=i,this.name="UploadError",Error.captureStackTrace(this,this.constructor)}}class x extends Error{constructor(e,t){super(e),this.field=t,this.name="ValidationError",Error.captureStackTrace(this,this.constructor)}}class O extends Error{constructor(e,t){super(e),this.cause=t,this.name="NetworkError",Error.captureStackTrace(this,this.constructor)}}class z extends Error{constructor(e,t){super(e),this.path=t,this.name="ScanError",Error.captureStackTrace(this,this.constructor)}}function me(r){return r instanceof O?!0:r instanceof D?r.statusCode?r.statusCode>=500:!1:r instanceof C?r.statusCode?r.statusCode>=500||r.statusCode===429:!1:r.code==="ECONNRESET"||r.code==="ETIMEDOUT"||r.code==="ENOTFOUND"||r.code==="ECONNREFUSED"}const be={maxRetries:3,initialDelay:1e3,maxDelay:3e4,shouldRetry:me,jitter:!0};async function I(r,e={}){const t={...be,...e};let n;for(let i=0;i<=t.maxRetries;i++)try{return await r()}catch(o){if(n=o,i>=t.maxRetries||t.shouldRetry&&!t.shouldRetry(o))throw o;let s;if(o.statusCode===429&&o.retryAfter?s=Math.min(o.retryAfter*1e3,t.maxDelay):s=Math.min(t.initialDelay*Math.pow(2,i),t.maxDelay),t.jitter){const a=s*.25;s=s+(Math.random()*a*2-a)}await xe(Math.floor(s))}throw n}function xe(r){return new Promise(e=>setTimeout(e,r))}class ve{constructor(e){u(this,"baseUrl");u(this,"timeout");u(this,"maxRetries");u(this,"retryInitialDelay");u(this,"retryMaxDelay");u(this,"retryJitter");u(this,"debug");this.baseUrl=e.baseUrl,this.timeout=e.timeout??3e4,this.maxRetries=e.maxRetries??3,this.retryInitialDelay=e.retryInitialDelay??1e3,this.retryMaxDelay=e.retryMaxDelay??3e4,this.retryJitter=e.retryJitter??!0,this.debug=e.debug??!1}async request(e,t,n){const i=`${this.baseUrl}${t}`;this.debug&&console.log(`HTTP Request: ${e} ${i}`,n);try{const o=new AbortController,s=setTimeout(()=>o.abort(),this.timeout),a=await fetch(i,{method:e,headers:{"Content-Type":"application/json"},body:n?JSON.stringify(n):void 0,signal:o.signal});clearTimeout(s);const l=await a.json();if(this.debug&&console.log(`HTTP Response: ${a.status}`,l),!a.ok){const d=l;throw new D(d.error||"Request failed",a.status,d.details)}return l}catch(o){throw o instanceof D?o:o.name==="AbortError"?new O(`Request timeout after ${this.timeout}ms`):new O(`Network request failed: ${o.message}`)}}async initBatch(e){return I(()=>this.request("POST","/api/batches/init",e),{maxRetries:this.maxRetries,initialDelay:this.retryInitialDelay,maxDelay:this.retryMaxDelay,jitter:this.retryJitter})}async startFileUpload(e,t){return I(()=>this.request("POST",`/api/batches/${e}/files/start`,t),{maxRetries:this.maxRetries,initialDelay:this.retryInitialDelay,maxDelay:this.retryMaxDelay,jitter:this.retryJitter})}async completeFileUpload(e,t){return I(()=>this.request("POST",`/api/batches/${e}/files/complete`,t),{maxRetries:this.maxRetries,initialDelay:this.retryInitialDelay,maxDelay:this.retryMaxDelay,jitter:this.retryJitter})}async finalizeBatch(e){return I(()=>this.request("POST",`/api/batches/${e}/finalize`,{}),{maxRetries:this.maxRetries,initialDelay:this.retryInitialDelay,maxDelay:this.retryMaxDelay,jitter:this.retryJitter})}}function Ee(){return typeof process<"u"&&process.versions!=null&&process.versions.node!=null?"node":typeof window<"u"&&typeof document<"u"?"browser":"unknown"}function Z(r){return r.replace(/\\/g,"/")}function De(r){const e=r.lastIndexOf(".");return e===-1?"":r.slice(e+1).toLowerCase()}function Y(r){const e=De(r);return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",tif:"image/tiff",tiff:"image/tiff",bmp:"image/bmp",svg:"image/svg+xml",pdf:"application/pdf",txt:"text/plain",json:"application/json",xml:"application/xml",html:"text/html",htm:"text/html",css:"text/css",js:"application/javascript",zip:"application/zip",tar:"application/x-tar",gz:"application/gzip",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg",mp4:"video/mp4",webm:"video/webm",mov:"video/quicktime"}[e]||"application/octet-stream"}async function Se(r,e,t,n={}){const{maxRetries:i=3,retryInitialDelay:o,retryMaxDelay:s,retryJitter:a}=n;await I(async()=>{let l;try{l=await fetch(e,{method:"PUT",body:r,headers:{...t?{"Content-Type":t}:{}}})}catch(d){throw new C(`Upload failed: ${d.message}`,void 0,void 0,d)}if(!l.ok){const d=l.headers.get("retry-after"),c=new C(`Upload failed with status ${l.status}: ${l.statusText}`,void 0,l.status);throw d&&l.status===429&&(c.retryAfter=parseInt(d,10)),c}},{maxRetries:i,initialDelay:o,maxDelay:s,jitter:a})}async function $e(r,e,t=3,n={}){const i=r.byteLength,o=Math.ceil(i/e.length),s=[],a=[],{maxRetries:l=3,retryInitialDelay:d,retryMaxDelay:c,retryJitter:p}=n;for(let f=0;f<e.length;f++){const $=f+1,h=f*o,y=Math.min(h+o,i),g=r.slice(h,y),b=e[f];a.push(async()=>{const w=await Ce(g,b,$,l,{initialDelay:d,maxDelay:c,jitter:p});s.push({part_number:$,etag:w})})}return await Pe(a,t),s.sort((f,$)=>f.part_number-$.part_number),s}async function Ce(r,e,t,n=3,i={}){return I(async()=>{let o;try{o=await fetch(e,{method:"PUT",body:r})}catch(a){throw new C(`Part ${t} upload failed: ${a.message}`,void 0,void 0,a)}if(!o.ok){const a=o.headers.get("retry-after"),l=new C(`Part ${t} upload failed with status ${o.status}: ${o.statusText}`,void 0,o.status);throw a&&o.status===429&&(l.retryAfter=parseInt(a,10)),l}const s=o.headers.get("etag");if(!s)throw new C(`Part ${t} upload succeeded but no ETag returned`,void 0,o.status);return s.replace(/"/g,"")},{maxRetries:n,initialDelay:i.initialDelay,maxDelay:i.maxDelay,jitter:i.jitter})}async function Pe(r,e){const t=[...r],n=[],i=async()=>{for(;t.length>0;)await t.shift()()};for(let o=0;o<Math.min(e,r.length);o++)n.push(i());await Promise.all(n)}const ee=5*1024*1024*1024,te=100*1024*1024*1024,Te=/[<>:"|?*\x00-\x1f]/,Ue=["image/jpeg","image/png","image/webp"];function re(r){if(r<=0)throw new x("File size must be greater than 0");if(r>ee)throw new x(`File size (${R(r)}) exceeds maximum allowed size (${R(ee)})`)}function Ae(r){if(r>te)throw new x(`Total batch size (${R(r)}) exceeds maximum allowed size (${R(te)})`)}function N(r){if(!r.startsWith("/"))throw new x("Logical path must start with /","path");if(Te.test(r))throw new x("Logical path contains invalid characters","path");const e=r.split("/").filter(t=>t.length>0);if(e.length===0&&r!=="/")throw new x("Logical path cannot be empty","path");for(const t of e)if(t==="."||t==="..")throw new x("Logical path cannot contain . or .. segments","path")}function ke(r,e,t){let n;try{n=JSON.parse(r)}catch(i){throw new x(`Invalid JSON in ${e}: ${i.message}`,"ref")}if(typeof n!="object"||Array.isArray(n)||n===null)throw new x(`${e} must contain a JSON object`,"ref");if(!n.url||typeof n.url!="string")throw new x(`${e} must contain a 'url' field with a string value`,"ref");try{const i=new URL(n.url);if(i.protocol!=="http:"&&i.protocol!=="https:")throw new Error("URL must use HTTP or HTTPS protocol")}catch(i){throw new x(`Invalid URL in ${e}: ${i.message}`,"ref")}if(n.type||t&&t.warn(`${e}: Missing 'type' field (optional but recommended)`),n.type&&Ue.includes(n.type)){const o={"image/jpeg":".jpg","image/png":".png","image/webp":".webp"}[n.type];o&&!e.includes(`${o}.ref.json`)&&t&&t.warn(`${e}: Type is '${n.type}' but filename doesn't include '${o}.ref.json' pattern. This file may not be processed by OCR. Consider renaming to include the extension (e.g., 'photo${o}.ref.json').`)}}function R(r){if(r===0)return"0 B";const e=1024,t=["B","KB","MB","GB","TB"],n=Math.floor(Math.log(r)/Math.log(e));return`${(r/Math.pow(e,n)).toFixed(2)} ${t[n]}`}function ze(r){if(!r)return;const e=5e4,t=75e3,n=["general","reorganization","pinax","description","cheimarros"];let i=0;for(const o of n){const s=r[o];if(s){if(s.length>e)throw new x(`Custom prompt '${o}' exceeds maximum length of ${e} characters (current: ${s.length})`,"customPrompts");i+=s.length}}if(i>t)throw new x(`Total custom prompts length (${i}) exceeds maximum of ${t} characters`,"customPrompts")}function Me(r){if(r&&"customPrompts"in r)throw new x("customPrompts must be a top-level field in UploaderConfig, not inside the processing config. Use: new ArkeUploader({ customPrompts: {...}, processing: {...} }) NOT: new ArkeUploader({ processing: { customPrompts: {...} } })","processing")}class Fe{constructor(e){u(this,"config");u(this,"workerClient");u(this,"scanner",null);u(this,"platform");Me(e.processing),this.config={rootPath:"/",parallelUploads:5,parallelParts:3,...e},this.workerClient=new ve({baseUrl:e.workerUrl,timeout:e.timeout,maxRetries:e.maxRetries,retryInitialDelay:e.retryInitialDelay,retryMaxDelay:e.retryMaxDelay,retryJitter:e.retryJitter,debug:!1}),this.platform=Ee()}async getScanner(){if(this.scanner)return this.scanner;if(this.platform==="node"){const{NodeScanner:e}=await Promise.resolve().then(()=>Et);this.scanner=new e}else if(this.platform==="browser"){const{BrowserScanner:e}=await Promise.resolve().then(()=>St);this.scanner=new e}else throw new x("Unsupported platform");return this.scanner}async uploadBatch(e,t={}){var $;const n=Date.now(),{onProgress:i,dryRun:o=!1}=t;this.reportProgress(i,{phase:"scanning",filesTotal:0,filesUploaded:0,bytesTotal:0,bytesUploaded:0,percentComplete:0});const a=await(await this.getScanner()).scanFiles(e,{rootPath:this.config.rootPath||"/",followSymlinks:!0,defaultProcessingConfig:this.config.processing});if(a.length===0)throw new x("No files found to upload");const l=a.reduce((h,y)=>h+y.size,0);if(Ae(l),this.config.customPrompts){ze(this.config.customPrompts);const h=Object.keys(this.config.customPrompts).filter(y=>this.config.customPrompts[y]);console.log(`[Arke Upload SDK] Custom prompts configured: ${h.join(", ")}`)}if(o)return{batchId:"dry-run",filesUploaded:a.length,bytesUploaded:l,durationMs:Date.now()-n};const{batch_id:d}=await this.workerClient.initBatch({uploader:this.config.uploader,root_path:this.config.rootPath||"/",parent_pi:this.config.parentPi||"",metadata:this.config.metadata,file_count:a.length,total_size:l,custom_prompts:this.config.customPrompts});this.config.customPrompts&&console.log(`[Arke Upload SDK] Custom prompts sent to worker for batch ${d}`),this.reportProgress(i,{phase:"uploading",filesTotal:a.length,filesUploaded:0,bytesTotal:l,bytesUploaded:0,percentComplete:0});let c=0,p=0;const{failedFiles:f}=await this.uploadFilesWithConcurrency(d,a,e,this.config.parallelUploads||5,(h,y)=>{c++,p+=y,this.reportProgress(i,{phase:"uploading",filesTotal:a.length,filesUploaded:c,bytesTotal:l,bytesUploaded:p,currentFile:h.fileName,percentComplete:Math.round(p/l*100)})});if(f.length===a.length)throw new x(`All ${a.length} files failed to upload. First error: ${(($=f[0])==null?void 0:$.error)||"Unknown"}`);return f.length>0&&console.warn(`Warning: ${f.length} of ${a.length} files failed to upload:`,f.map(h=>`${h.file.fileName}: ${h.error}`).join(", ")),this.reportProgress(i,{phase:"finalizing",filesTotal:a.length,filesUploaded:c,bytesTotal:l,bytesUploaded:p,percentComplete:99}),await this.workerClient.finalizeBatch(d),this.reportProgress(i,{phase:"complete",filesTotal:a.length,filesUploaded:c,bytesTotal:l,bytesUploaded:p,percentComplete:100}),{batchId:d,filesUploaded:c,bytesUploaded:p,durationMs:Date.now()-n}}async uploadFilesWithConcurrency(e,t,n,i,o){const s=[...t],a=[],l=[],d=async()=>{for(;s.length>0;){const c=s.shift();try{await this.uploadSingleFile(e,c,n),o(c,c.size)}catch(p){const f=p.message||"Unknown error";console.error(`Failed to upload ${c.fileName}: ${f}`),l.push({file:c,error:f})}}};for(let c=0;c<Math.min(i,t.length);c++)a.push(d());return await Promise.all(a),{failedFiles:l}}async uploadSingleFile(e,t,n){const i=await this.workerClient.startFileUpload(e,{file_name:t.fileName,file_size:t.size,logical_path:t.logicalPath,content_type:t.contentType,cid:t.cid,processing_config:t.processingConfig}),o=await this.getFileData(t,n),s={maxRetries:this.config.maxRetries,retryInitialDelay:this.config.retryInitialDelay,retryMaxDelay:this.config.retryMaxDelay,retryJitter:this.config.retryJitter};if(i.upload_type==="simple")await Se(o,i.presigned_url,t.contentType,s);else{const a=i.presigned_urls.map(d=>d.url),l=await $e(o,a,this.config.parallelParts||3,s);await this.workerClient.completeFileUpload(e,{r2_key:i.r2_key,upload_id:i.upload_id,parts:l});return}await this.workerClient.completeFileUpload(e,{r2_key:i.r2_key})}async getFileData(e,t){if(this.platform==="node"){const i=await(await Promise.resolve().then(()=>ne)).readFile(e.localPath);return i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength)}else if(this.platform==="browser"){const i=(Array.isArray(t)?t:[t]).find(o=>o instanceof File&&o.name===e.fileName);if(!i)throw new Error(`Could not find browser File object for ${e.fileName}`);return i.arrayBuffer()}throw new Error("Unsupported platform for file reading")}reportProgress(e,t){e&&e(t)}}const S={},ne=Object.freeze(Object.defineProperty({__proto__:null,default:S},Symbol.toStringTag,{value:"Module"}));function Ie(r,e){if(r===e)return!0;if(r.byteLength!==e.byteLength)return!1;for(let t=0;t<r.byteLength;t++)if(r[t]!==e[t])return!1;return!0}function W(r){if(r instanceof Uint8Array&&r.constructor.name==="Uint8Array")return r;if(r instanceof ArrayBuffer)return new Uint8Array(r);if(ArrayBuffer.isView(r))return new Uint8Array(r.buffer,r.byteOffset,r.byteLength);throw new Error("Unknown type, must be binary type")}function je(r,e){if(r.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),n=0;n<t.length;n++)t[n]=255;for(var i=0;i<r.length;i++){var o=r.charAt(i),s=o.charCodeAt(0);if(t[s]!==255)throw new TypeError(o+" is ambiguous");t[s]=i}var a=r.length,l=r.charAt(0),d=Math.log(a)/Math.log(256),c=Math.log(256)/Math.log(a);function p(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";for(var y=0,g=0,b=0,w=h.length;b!==w&&h[b]===0;)b++,y++;for(var m=(w-b)*c+1>>>0,P=new Uint8Array(m);b!==w;){for(var U=h[b],F=0,T=m-1;(U!==0||F<g)&&T!==-1;T--,F++)U+=256*P[T]>>>0,P[T]=U%a>>>0,U=U/a>>>0;if(U!==0)throw new Error("Non-zero carry");g=F,b++}for(var k=m-g;k!==m&&P[k]===0;)k++;for(var V=l.repeat(y);k<m;++k)V+=r.charAt(P[k]);return V}function f(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;var y=0;if(h[y]!==" "){for(var g=0,b=0;h[y]===l;)g++,y++;for(var w=(h.length-y)*d+1>>>0,m=new Uint8Array(w);h[y];){var P=t[h.charCodeAt(y)];if(P===255)return;for(var U=0,F=w-1;(P!==0||U<b)&&F!==-1;F--,U++)P+=a*m[F]>>>0,m[F]=P%256>>>0,P=P/256>>>0;if(P!==0)throw new Error("Non-zero carry");b=U,y++}if(h[y]!==" "){for(var T=w-b;T!==w&&m[T]===0;)T++;for(var k=new Uint8Array(g+(w-T)),V=g;T!==w;)k[V++]=m[T++];return k}}}function $(h){var y=f(h);if(y)return y;throw new Error(`Non-${e} character`)}return{encode:p,decodeUnsafe:f,decode:$}}var Oe=je,Ne=Oe;class Re{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseEncode");this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class _e{constructor(e,t,n){u(this,"name");u(this,"prefix");u(this,"baseDecode");u(this,"prefixCodePoint");this.name=e,this.prefix=t;const i=t.codePointAt(0);if(i===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=i,this.baseDecode=n}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return ie(this,e)}}class Le{constructor(e){u(this,"decoders");this.decoders=e}or(e){return ie(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n!=null)return n.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function ie(r,e){return new Le({...r.decoders??{[r.prefix]:r},...e.decoders??{[e.prefix]:e}})}class Be{constructor(e,t,n,i){u(this,"name");u(this,"prefix");u(this,"baseEncode");u(this,"baseDecode");u(this,"encoder");u(this,"decoder");this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=i,this.encoder=new Re(e,t,n),this.decoder=new _e(e,t,i)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function oe({name:r,prefix:e,encode:t,decode:n}){return new Be(r,e,t,n)}function _({name:r,prefix:e,alphabet:t}){const{encode:n,decode:i}=Ne(t,r);return oe({prefix:e,name:r,encode:n,decode:o=>W(i(o))})}function qe(r,e,t,n){let i=r.length;for(;r[i-1]==="=";)--i;const o=new Uint8Array(i*t/8|0);let s=0,a=0,l=0;for(let d=0;d<i;++d){const c=e[r[d]];if(c===void 0)throw new SyntaxError(`Non-${n} character`);a=a<<t|c,s+=t,s>=8&&(s-=8,o[l++]=255&a>>s)}if(s>=t||255&a<<8-s)throw new SyntaxError("Unexpected end of data");return o}function Je(r,e,t){const n=e[e.length-1]==="=",i=(1<<t)-1;let o="",s=0,a=0;for(let l=0;l<r.length;++l)for(a=a<<8|r[l],s+=8;s>t;)s-=t,o+=e[i&a>>s];if(s!==0&&(o+=e[i&a<<t-s]),n)for(;o.length*t&7;)o+="=";return o}function Ve(r){const e={};for(let t=0;t<r.length;++t)e[r[t]]=t;return e}function A({name:r,prefix:e,bitsPerChar:t,alphabet:n}){const i=Ve(n);return oe({prefix:e,name:r,encode(o){return Je(o,n,t)},decode(o){return qe(o,i,t,r)}})}const L=A({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});A({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),A({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),A({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),A({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),A({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),A({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),A({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),A({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const G=_({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"});_({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});const M=_({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"});_({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var We=ae,se=128,Ge=-128,He=Math.pow(2,31);function ae(r,e,t){e=e||[],t=t||0;for(var n=t;r>=He;)e[t++]=r&255|se,r/=128;for(;r&Ge;)e[t++]=r&255|se,r>>>=7;return e[t]=r|0,ae.bytes=t-n+1,e}var Ke=H,Xe=128,ce=127;function H(r,n){var t=0,n=n||0,i=0,o=n,s,a=r.length;do{if(o>=a)throw H.bytes=0,new RangeError("Could not decode varint");s=r[o++],t+=i<28?(s&ce)<<i:(s&ce)*Math.pow(2,i),i+=7}while(s>=Xe);return H.bytes=o-n,t}var Qe=Math.pow(2,7),Ze=Math.pow(2,14),Ye=Math.pow(2,21),et=Math.pow(2,28),tt=Math.pow(2,35),rt=Math.pow(2,42),nt=Math.pow(2,49),it=Math.pow(2,56),ot=Math.pow(2,63),st=function(r){return r<Qe?1:r<Ze?2:r<Ye?3:r<et?4:r<tt?5:r<rt?6:r<nt?7:r<it?8:r<ot?9:10},at={encode:We,decode:Ke,encodingLength:st},B=at;function K(r,e=0){return[B.decode(r,e),B.decode.bytes]}function q(r,e,t=0){return B.encode(r,e,t),e}function J(r){return B.encodingLength(r)}function le(r,e){const t=e.byteLength,n=J(r),i=n+J(t),o=new Uint8Array(i+t);return q(r,o,0),q(t,o,n),o.set(e,i),new X(r,t,e,o)}function ct(r){const e=W(r),[t,n]=K(e),[i,o]=K(e.subarray(n)),s=e.subarray(n+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new X(t,i,s,e)}function lt(r,e){if(r===e)return!0;{const t=e;return r.code===t.code&&r.size===t.size&&t.bytes instanceof Uint8Array&&Ie(r.bytes,t.bytes)}}class X{constructor(e,t,n,i){u(this,"code");u(this,"size");u(this,"digest");u(this,"bytes");this.code=e,this.size=t,this.digest=n,this.bytes=i}}function he(r,e){const{bytes:t,version:n}=r;switch(n){case 0:return ft(t,Q(r),e??M.encoder);default:return ut(t,Q(r),e??L.encoder)}}const fe=new WeakMap;function Q(r){const e=fe.get(r);if(e==null){const t=new Map;return fe.set(r,t),t}return e}class v{constructor(e,t,n,i){u(this,"code");u(this,"version");u(this,"multihash");u(this,"bytes");u(this,"/");u(this,ge,"CID");this.code=t,this.version=e,this.multihash=n,this.bytes=i,this["/"]=i}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==j)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==dt)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return v.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=le(e,t);return v.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return v.equals(this,e)}static equals(e,t){const n=t;return n!=null&&e.code===n.code&&e.version===n.version&&lt(e.multihash,n.multihash)}toString(e){return he(this,e)}toJSON(){return{"/":he(this)}}link(){return this}[(ge=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof v)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:n,code:i,multihash:o,bytes:s}=t;return new v(n,i,o,s??ue(n,i,o.bytes))}else if(t[pt]===!0){const{version:n,multihash:i,code:o}=t,s=ct(i);return v.create(n,o,s)}else return null}static create(e,t,n){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==j)throw new Error(`Version 0 CID must use dag-pb (code: ${j}) block encoding`);return new v(e,t,n,n.bytes)}case 1:{const i=ue(e,t,n.bytes);return new v(e,t,n,i)}default:throw new Error("Invalid version")}}static createV0(e){return v.create(0,j,e)}static createV1(e,t){return v.create(1,e,t)}static decode(e){const[t,n]=v.decodeFirst(e);if(n.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=v.inspectBytes(e),n=t.size-t.multihashSize,i=W(e.subarray(n,n+t.multihashSize));if(i.byteLength!==t.multihashSize)throw new Error("Incorrect length");const o=i.subarray(t.multihashSize-t.digestSize),s=new X(t.multihashCode,t.digestSize,o,i);return[t.version===0?v.createV0(s):v.createV1(t.codec,s),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[p,f]=K(e.subarray(t));return t+=f,p};let i=n(),o=j;if(i===18?(i=0,t=0):o=n(),i!==0&&i!==1)throw new RangeError(`Invalid CID version ${i}`);const s=t,a=n(),l=n(),d=t+l,c=d-s;return{version:i,codec:o,multihashCode:a,digestSize:l,multihashSize:c,size:d}}static parse(e,t){const[n,i]=ht(e,t),o=v.decode(i);if(o.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Q(o).set(n,e),o}}function ht(r,e){switch(r[0]){case"Q":{const t=e??M;return[M.prefix,t.decode(`${M.prefix}${r}`)]}case M.prefix:{const t=e??M;return[M.prefix,t.decode(r)]}case L.prefix:{const t=e??L;return[L.prefix,t.decode(r)]}case G.prefix:{const t=e??G;return[G.prefix,t.decode(r)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[r[0],e.decode(r)]}}}function ft(r,e,t){const{prefix:n}=t;if(n!==M.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const i=e.get(n);if(i==null){const o=t.encode(r).slice(1);return e.set(n,o),o}else return i}function ut(r,e,t){const{prefix:n}=t,i=e.get(n);if(i==null){const o=t.encode(r);return e.set(n,o),o}else return i}const j=112,dt=18;function ue(r,e,t){const n=J(r),i=n+J(e),o=new Uint8Array(i+t.byteLength);return q(r,o,0),q(e,o,n),o.set(t,i),o}const pt=Symbol.for("@ipld/js-cid/CID"),de=85,yt=20;function wt({name:r,code:e,encode:t,minDigestLength:n,maxDigestLength:i}){return new gt(r,e,t,n,i)}class gt{constructor(e,t,n,i,o){u(this,"name");u(this,"code");u(this,"encode");u(this,"minDigestLength");u(this,"maxDigestLength");this.name=e,this.code=t,this.encode=n,this.minDigestLength=i??yt,this.maxDigestLength=o}digest(e,t){if((t==null?void 0:t.truncate)!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){const n=this.encode(e);return n instanceof Uint8Array?pe(n,this.code,t==null?void 0:t.truncate):n.then(i=>pe(i,this.code,t==null?void 0:t.truncate))}else throw Error("Unknown type, must be binary type")}}function pe(r,e,t){if(t!=null&&t!==r.byteLength){if(t>r.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${r.byteLength}`);r=r.subarray(0,t)}return le(e,r)}function mt(r){return async e=>new Uint8Array(await crypto.subtle.digest(r,e))}const ye=wt({name:"sha2-256",code:18,encode:mt("SHA-256")});async function bt(r){const e=await Promise.resolve().then(()=>ne);try{const t=await e.readFile(r),n=await ye.digest(t);return v.create(1,de,n).toString()}catch(t){throw new Error(`CID computation failed: ${t.message}`)}}async function xt(r){const e=await ye.digest(r);return v.create(1,de,e).toString()}const we={ocr:!0,describe:!0,pinax:!0};class vt{async scanFiles(e,t){const n=Array.isArray(e)?e[0]:e;if(!n||typeof n!="string")throw new z("Node.js scanner requires a directory path","");const i=[];try{if(!(await S.stat(n)).isDirectory())throw new z(`Path is not a directory: ${n}`,n)}catch(c){throw c.code==="ENOENT"?new z(`Directory not found: ${n}`,n):new z(`Cannot access directory: ${c.message}`,n)}N(t.rootPath);const o=t.defaultProcessingConfig||we;async function s(c){const p=S.join(c,".arke-process.json");try{const f=await S.readFile(p,"utf-8");return JSON.parse(f)}catch(f){return f.code!=="ENOENT"&&console.warn(`Error reading processing config ${p}: ${f.message}`),null}}function a(c,p){return p?{ocr:p.ocr??c.ocr,describe:p.describe??c.describe,pinax:p.pinax??c.pinax}:c}async function l(c,p=""){const f=await s(c),$=a(o,f);let h;try{h=await S.readdir(c,{withFileTypes:!0})}catch(y){console.warn(`Cannot read directory: ${c}`,y.message);return}for(const y of h){const g=S.join(c,y.name),b=S.join(p,y.name);try{if(y.isSymbolicLink()){if(!t.followSymlinks)continue;const w=await S.stat(g);w.isDirectory()?await l(g,b):w.isFile()&&await d(g,b,w.size,$);continue}if(y.isDirectory()){await l(g,b);continue}if(y.isFile()){const w=await S.stat(g);await d(g,b,w.size,$)}}catch(w){if(w instanceof z&&w.message.includes(".ref.json"))throw w;console.warn(`Error processing ${g}: ${w.message}`);continue}}}async function d(c,p,f,$){const h=S.basename(c);if(h===".arke-process.json")return;if(h.endsWith(".ref.json"))try{const m=await S.readFile(c,"utf-8");ke(m,h,console)}catch(m){throw new z(`Invalid .ref.json file: ${h} - ${m.message}`,c)}try{re(f)}catch(m){console.warn(`Skipping file that exceeds size limit: ${h}`,m.message);return}const y=Z(p),g=S.posix.join(t.rootPath,y);try{N(g)}catch(m){console.warn(`Skipping file with invalid logical path: ${g}`,m.message);return}const b=Y(h);try{await S.access(c,S.constants.R_OK)}catch{console.warn(`Skipping unreadable file: ${c}`);return}let w;try{w=await bt(c)}catch(m){console.warn(`Warning: CID computation failed for ${c}, continuing without CID:`,m.message),w=void 0}i.push({localPath:c,logicalPath:g,fileName:h,size:f,contentType:b,cid:w,processingConfig:$})}return await l(n),i.sort((c,p)=>c.size-p.size),i}async readFile(e){const t=await S.readFile(e.localPath);return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}}const Et=Object.freeze(Object.defineProperty({__proto__:null,NodeScanner:vt},Symbol.toStringTag,{value:"Module"}));class Dt{async scanFiles(e,t){const n=Array.isArray(e)?e:[e];if(n.length===0)throw new z("No files provided","");N(t.rootPath);const i=t.defaultProcessingConfig||we,o=[];for(const s of n)try{const a=await this.processFile(s,t.rootPath,i);a&&o.push(a)}catch(a){console.warn(`Error processing ${s.name}: ${a.message}`);continue}return o.sort((s,a)=>s.size-a.size),o}async processFile(e,t,n){const i=e.name,o=e.size;if(i.startsWith(".")||["Thumbs.db","desktop.ini","__MACOSX"].includes(i)||i===".arke-process.json")return null;try{re(o)}catch(f){return console.warn(`Skipping file that exceeds size limit: ${i}`,f.message),null}let a="";if("webkitRelativePath"in e&&e.webkitRelativePath){const f=e.webkitRelativePath.split("/");f.length>1?a=f.slice(1).join("/"):a=i}else a=i;const l=Z(a),d=`${t}/${l}`.replace(/\/+/g,"/");try{N(d)}catch(f){return console.warn(`Skipping file with invalid logical path: ${d}`,f.message),null}const c=e.type||Y(i);let p;try{const f=await e.arrayBuffer();p=await xt(new Uint8Array(f))}catch(f){console.warn(`Warning: CID computation failed for ${i}, continuing without CID:`,f.message),p=void 0}return{localPath:`__browser_file__${i}`,logicalPath:d,fileName:i,size:o,contentType:c,cid:p,processingConfig:n}}async readFile(e){throw new Error("Browser scanner requires File objects to be provided directly during upload")}}const St=Object.freeze(Object.defineProperty({__proto__:null,BrowserScanner:Dt},Symbol.toStringTag,{value:"Module"}));E.ArkeUploader=Fe,E.NetworkError=O,E.ScanError=z,E.UploadError=C,E.ValidationError=x,E.WorkerAPIError=D,Object.defineProperty(E,Symbol.toStringTag,{value:"Module"})});
